<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Genome Transition Predictor</title>
<style>
  :root {
    --bg: #0f172a;
    --surface: #1e293b;
    --surface2: #334155;
    --border: #475569;
    --text: #f1f5f9;
    --text-muted: #94a3b8;
    --accent: #3b82f6;
    --accent-hover: #2563eb;
    --green: #22c55e;
    --red: #ef4444;
    --amber: #f59e0b;
    --cyan: #06b6d4;
    --ei: #3b82f6;
    --ie: #8b5cf6;
    --ze: #06b6d4;
    --ez: #f59e0b;
    --radius: 12px;
    --shadow: 0 4px 24px rgba(0,0,0,.3);
  }

  * { margin: 0; padding: 0; box-sizing: border-box; }

  body {
    font-family: 'Segoe UI', system-ui, -apple-system, sans-serif;
    background: var(--bg);
    color: var(--text);
    min-height: 100vh;
    line-height: 1.6;
  }

  .container {
    max-width: 1100px;
    margin: 0 auto;
    padding: 2rem 1.5rem;
  }

  header {
    text-align: center;
    margin-bottom: 2.5rem;
  }

  header h1 {
    font-size: 1.75rem;
    font-weight: 700;
    letter-spacing: -0.02em;
    margin-bottom: .25rem;
  }

  header h1 span { color: var(--accent); }

  header p {
    color: var(--text-muted);
    font-size: .95rem;
  }

  /* Input panel */
  .input-panel {
    background: var(--surface);
    border: 1px solid var(--border);
    border-radius: var(--radius);
    padding: 1.5rem;
    margin-bottom: 1.5rem;
    box-shadow: var(--shadow);
  }

  .input-panel label {
    display: block;
    font-weight: 600;
    font-size: .85rem;
    text-transform: uppercase;
    letter-spacing: .06em;
    color: var(--text-muted);
    margin-bottom: .4rem;
  }

  textarea {
    width: 100%;
    min-height: 120px;
    background: var(--bg);
    border: 1px solid var(--border);
    border-radius: 8px;
    color: var(--text);
    font-family: 'Cascadia Code', 'Fira Code', 'Consolas', monospace;
    font-size: .9rem;
    padding: .75rem 1rem;
    resize: vertical;
    transition: border-color .2s;
  }

  textarea:focus {
    outline: none;
    border-color: var(--accent);
  }

  .controls {
    display: flex;
    gap: 1rem;
    margin-top: 1rem;
    flex-wrap: wrap;
    align-items: flex-end;
  }

  .control-group {
    display: flex;
    flex-direction: column;
    gap: .25rem;
  }

  .control-group label {
    font-size: .75rem;
    margin-bottom: 0;
  }

  .control-group input {
    width: 100px;
    background: var(--bg);
    border: 1px solid var(--border);
    border-radius: 8px;
    color: var(--text);
    font-size: .9rem;
    padding: .5rem .75rem;
    transition: border-color .2s;
  }

  .control-group input:focus {
    outline: none;
    border-color: var(--accent);
  }

  .btn {
    padding: .6rem 1.75rem;
    border: none;
    border-radius: 8px;
    font-size: .9rem;
    font-weight: 600;
    cursor: pointer;
    transition: all .2s;
    display: inline-flex;
    align-items: center;
    gap: .5rem;
  }

  .btn-primary {
    background: var(--accent);
    color: #fff;
    margin-left: auto;
  }

  .btn-primary:hover { background: var(--accent-hover); }

  .btn-primary:disabled {
    opacity: .5;
    cursor: not-allowed;
  }

  .btn-sample {
    background: var(--surface2);
    color: var(--text-muted);
    font-size: .8rem;
    padding: .5rem 1rem;
  }

  .btn-sample:hover {
    background: var(--border);
    color: var(--text);
  }

  .seq-length {
    color: var(--text-muted);
    font-size: .8rem;
    margin-left: .5rem;
    align-self: center;
  }

  /* Status bar */
  .status {
    text-align: center;
    padding: 1rem;
    color: var(--text-muted);
    font-size: .9rem;
    display: none;
  }

  .status.visible { display: block; }

  .status.error { color: var(--red); }

  .spinner {
    display: inline-block;
    width: 18px;
    height: 18px;
    border: 2px solid var(--border);
    border-top-color: var(--accent);
    border-radius: 50%;
    animation: spin .6s linear infinite;
    vertical-align: middle;
    margin-right: .5rem;
  }

  @keyframes spin { to { transform: rotate(360deg); } }

  /* Results */
  .results { display: none; }
  .results.visible { display: block; }

  .results-header {
    display: flex;
    justify-content: space-between;
    align-items: center;
    margin-bottom: 1rem;
  }

  .results-header h2 {
    font-size: 1.15rem;
    font-weight: 600;
  }

  .results-header .seq-info {
    color: var(--text-muted);
    font-size: .85rem;
  }

  .transition-grid {
    display: grid;
    grid-template-columns: repeat(auto-fit, minmax(480px, 1fr));
    gap: 1rem;
  }

  .transition-card {
    background: var(--surface);
    border: 1px solid var(--border);
    border-radius: var(--radius);
    overflow: hidden;
    box-shadow: var(--shadow);
  }

  .card-header {
    display: flex;
    justify-content: space-between;
    align-items: center;
    padding: .85rem 1.25rem;
    border-bottom: 1px solid var(--border);
  }

  .card-header .zone-badge {
    display: inline-flex;
    align-items: center;
    gap: .5rem;
    font-weight: 700;
    font-size: 1.05rem;
  }

  .zone-dot {
    width: 10px;
    height: 10px;
    border-radius: 50%;
    display: inline-block;
  }

  .card-header .meta {
    font-size: .8rem;
    color: var(--text-muted);
  }

  .card-body { padding: 1rem 1.25rem; }

  .no-hits {
    text-align: center;
    color: var(--text-muted);
    font-size: .85rem;
    padding: 1rem 0;
  }

  .hits-table {
    width: 100%;
    border-collapse: collapse;
    font-size: .85rem;
  }

  .hits-table th {
    text-align: left;
    color: var(--text-muted);
    font-weight: 600;
    font-size: .75rem;
    text-transform: uppercase;
    letter-spacing: .05em;
    padding: .4rem .5rem;
    border-bottom: 1px solid var(--border);
  }

  .hits-table td {
    padding: .55rem .5rem;
    border-bottom: 1px solid rgba(71,85,105,.3);
    font-family: 'Cascadia Code', 'Fira Code', monospace;
  }

  .hits-table tr:last-child td { border-bottom: none; }

  .prob-bar-cell {
    display: flex;
    align-items: center;
    gap: .5rem;
  }

  .prob-bar-bg {
    flex: 1;
    height: 6px;
    background: var(--bg);
    border-radius: 3px;
    overflow: hidden;
    min-width: 60px;
  }

  .prob-bar-fill {
    height: 100%;
    border-radius: 3px;
    transition: width .4s ease;
  }

  .prob-value {
    min-width: 48px;
    text-align: right;
    font-weight: 600;
  }

  .rank-badge {
    display: inline-flex;
    align-items: center;
    justify-content: center;
    width: 22px;
    height: 22px;
    border-radius: 50%;
    background: var(--surface2);
    font-size: .7rem;
    font-weight: 700;
    color: var(--text-muted);
  }

  /* Sequence viewer */
  .sequence-viewer {
    background: var(--surface);
    border: 1px solid var(--border);
    border-radius: var(--radius);
    padding: 1.25rem;
    margin-top: 1rem;
    box-shadow: var(--shadow);
  }

  .sequence-viewer h3 {
    font-size: .95rem;
    font-weight: 600;
    margin-bottom: .75rem;
  }

  .seq-display {
    font-family: 'Cascadia Code', 'Fira Code', monospace;
    font-size: .75rem;
    line-height: 1.8;
    word-break: break-all;
    color: var(--text-muted);
    max-height: 200px;
    overflow-y: auto;
    padding: .75rem;
    background: var(--bg);
    border-radius: 8px;
  }

  .seq-display .hl-ei { background: rgba(59,130,246,.35); color: #93c5fd; border-radius: 2px; }
  .seq-display .hl-ie { background: rgba(139,92,246,.35); color: #c4b5fd; border-radius: 2px; }
  .seq-display .hl-ze { background: rgba(6,182,212,.35);  color: #67e8f9; border-radius: 2px; }
  .seq-display .hl-ez { background: rgba(245,158,11,.35); color: #fcd34d; border-radius: 2px; }

  .legend {
    display: flex;
    gap: 1.25rem;
    margin-top: .75rem;
    flex-wrap: wrap;
  }

  .legend-item {
    display: flex;
    align-items: center;
    gap: .35rem;
    font-size: .8rem;
    color: var(--text-muted);
  }

  .legend-swatch {
    width: 14px;
    height: 14px;
    border-radius: 3px;
  }

  /* Health badge */
  .health-bar {
    display: flex;
    justify-content: center;
    gap: .75rem;
    margin-bottom: 1.5rem;
    flex-wrap: wrap;
  }

  .health-chip {
    display: inline-flex;
    align-items: center;
    gap: .35rem;
    background: var(--surface);
    border: 1px solid var(--border);
    border-radius: 20px;
    padding: .3rem .8rem;
    font-size: .75rem;
    color: var(--text-muted);
  }

  .health-chip .dot {
    width: 7px;
    height: 7px;
    border-radius: 50%;
    background: var(--green);
  }

  .health-chip .dot.warn { background: var(--amber); }
  .health-chip .dot.err  { background: var(--red); }

  @media (max-width: 600px) {
    .transition-grid { grid-template-columns: 1fr; }
    .controls { flex-direction: column; align-items: stretch; }
    .btn-primary { margin-left: 0; }
    .control-group input { width: 100%; }
  }
</style>
</head>
<body>

<div class="container">
  <header>
    <h1><span>Genome</span> Transition Predictor</h1>
    <p>Detect EI, IE, ZE, and EZ transition zones in nucleotide sequences</p>
  </header>

  <div class="health-bar" id="healthBar"></div>

  <div class="input-panel">
    <label for="sequence">Nucleotide Sequence</label>
    <textarea id="sequence" placeholder="Paste your nucleotide sequence here (A, C, G, T)..."></textarea>
    <div class="controls">
      <button class="btn btn-sample" onclick="loadSample()">Load sample</button>
      <span class="seq-length" id="seqLength">0 nt</span>
      <div class="control-group">
        <label for="topK">Top K</label>
        <input type="number" id="topK" value="5" min="1" max="100">
      </div>
      <div class="control-group">
        <label for="minProb">Min Probability</label>
        <input type="number" id="minProb" value="0.5" min="0" max="1" step="0.05">
      </div>
      <button class="btn btn-primary" id="predictBtn" onclick="predict()">
        Predict
      </button>
    </div>
  </div>

  <div class="status" id="status"></div>

  <div class="results" id="results">
    <div class="results-header">
      <h2>Predictions</h2>
      <span class="seq-info" id="seqInfo"></span>
    </div>
    <div class="transition-grid" id="transitionGrid"></div>
    <div class="sequence-viewer" id="seqViewer">
      <h3>Sequence with highlighted hits</h3>
      <div class="seq-display" id="seqDisplay"></div>
      <div class="legend">
        <div class="legend-item"><div class="legend-swatch" style="background:rgba(59,130,246,.5)"></div> EI</div>
        <div class="legend-item"><div class="legend-swatch" style="background:rgba(139,92,246,.5)"></div> IE</div>
        <div class="legend-item"><div class="legend-swatch" style="background:rgba(6,182,212,.5)"></div> ZE</div>
        <div class="legend-item"><div class="legend-swatch" style="background:rgba(245,158,11,.5)"></div> EZ</div>
      </div>
    </div>
  </div>
</div>

<script>
const ZONE_COLORS = { EI: 'var(--ei)', IE: 'var(--ie)', ZE: 'var(--ze)', EZ: 'var(--ez)' };
const ZONE_LABELS = {
  EI: 'Exon \u2192 Intron',
  IE: 'Intron \u2192 Exon',
  ZE: 'Intergenic \u2192 Exon',
  EZ: 'Exon \u2192 Intergenic',
};
const HL_CLASS = { EI: 'hl-ei', IE: 'hl-ie', ZE: 'hl-ze', EZ: 'hl-ez' };

const seqInput = document.getElementById('sequence');
const seqLength = document.getElementById('seqLength');

seqInput.addEventListener('input', () => {
  const len = seqInput.value.replace(/\s/g, '').length;
  seqLength.textContent = len.toLocaleString() + ' nt';
});

async function checkHealth() {
  try {
    const r = await fetch('/health');
    const d = await r.json();
    const bar = document.getElementById('healthBar');
    const transitions = d.configured_transitions || [];
    const missing = new Set(d.missing_model_paths || []);
    bar.innerHTML = transitions.map(t => {
      const ok = !missing.has(t);
      return `<div class="health-chip">
        <span class="dot ${ok ? '' : 'err'}"></span>${t} ${ok ? 'ready' : 'missing'}
      </div>`;
    }).join('');
  } catch(e) {
    document.getElementById('healthBar').innerHTML =
      '<div class="health-chip"><span class="dot err"></span>API offline</div>';
  }
}

function loadSample() {
  const bases = 'acgt';
  let seq = '';
  for (let i = 0; i < 800; i++) seq += bases[Math.floor(Math.random()*4)];
  seqInput.value = seq;
  seqInput.dispatchEvent(new Event('input'));
}

function showStatus(msg, isError) {
  const el = document.getElementById('status');
  el.className = 'status visible' + (isError ? ' error' : '');
  el.innerHTML = isError ? msg : '<span class="spinner"></span>' + msg;
}

function hideStatus() {
  document.getElementById('status').className = 'status';
}

async function predict() {
  const sequence = seqInput.value.replace(/\s/g, '').toLowerCase();
  if (sequence.length < 12) {
    showStatus('Sequence must be at least 12 nucleotides long.', true);
    return;
  }

  const topK = parseInt(document.getElementById('topK').value) || 5;
  const minProb = parseFloat(document.getElementById('minProb').value) || 0;

  const btn = document.getElementById('predictBtn');
  btn.disabled = true;
  showStatus('Running inference on ' + sequence.length.toLocaleString() + ' nucleotides\u2026');
  document.getElementById('results').className = 'results';

  try {
    const resp = await fetch('/predict', {
      method: 'POST',
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify({ sequence, top_k: topK, min_probability: minProb }),
    });

    if (!resp.ok) {
      const err = await resp.json().catch(() => ({}));
      throw new Error(err.detail || `HTTP ${resp.status}`);
    }

    const data = await resp.json();
    hideStatus();
    renderResults(data, sequence);
  } catch (e) {
    showStatus('Error: ' + e.message, true);
  } finally {
    btn.disabled = false;
  }
}

function renderResults(data, sequence) {
  document.getElementById('results').className = 'results visible';
  document.getElementById('seqInfo').textContent =
    'Sequence length: ' + data.sequence_length.toLocaleString() + ' nt';

  const grid = document.getElementById('transitionGrid');
  const order = ['EI', 'IE', 'ZE', 'EZ'];
  let allHits = [];

  grid.innerHTML = order.map(zone => {
    const t = data.transitions[zone];
    if (!t) return '';

    t.hits.forEach((h, i) => allHits.push({ zone, rank: i+1, ...h }));

    const hitsHTML = t.hits.length === 0
      ? '<div class="no-hits">No hits above threshold</div>'
      : `<table class="hits-table">
          <thead><tr>
            <th>#</th><th>Start</th><th>End</th><th>Probability</th>
          </tr></thead>
          <tbody>${t.hits.map((h, i) => `<tr>
            <td><span class="rank-badge">${i+1}</span></td>
            <td>${h.start_index_based.toLocaleString()}</td>
            <td>${h.end_index_based.toLocaleString()}</td>
            <td><div class="prob-bar-cell">
              <div class="prob-bar-bg"><div class="prob-bar-fill" style="width:${(h.probability*100).toFixed(1)}%;background:${ZONE_COLORS[zone]}"></div></div>
              <span class="prob-value">${(h.probability*100).toFixed(1)}%</span>
            </div></td>
          </tr>`).join('')}</tbody>
        </table>`;

    return `<div class="transition-card">
      <div class="card-header">
        <span class="zone-badge">
          <span class="zone-dot" style="background:${ZONE_COLORS[zone]}"></span>
          ${zone} <span style="font-weight:400;font-size:.8rem;color:var(--text-muted)">${ZONE_LABELS[zone]}</span>
        </span>
        <span class="meta">${t.returned_hits} hit${t.returned_hits!==1?'s':''} / ${t.total_windows.toLocaleString()} windows</span>
      </div>
      <div class="card-body">${hitsHTML}</div>
    </div>`;
  }).join('');

  renderSequenceViewer(sequence, allHits);
}

function renderSequenceViewer(sequence, hits) {
  const marks = new Array(sequence.length).fill(null);

  hits.forEach(h => {
    const start = h.start_index_based - 1;
    const end = h.end_index_based - 1;
    for (let i = Math.max(0, start); i <= Math.min(end, sequence.length - 1); i++) {
      if (!marks[i]) marks[i] = h.zone;
    }
  });

  let html = '';
  let currentClass = null;

  for (let i = 0; i < sequence.length; i++) {
    const cls = marks[i] ? HL_CLASS[marks[i]] : null;
    if (cls !== currentClass) {
      if (currentClass) html += '</span>';
      if (cls) html += `<span class="${cls}">`;
      currentClass = cls;
    }
    html += sequence[i];
  }
  if (currentClass) html += '</span>';

  document.getElementById('seqDisplay').innerHTML = html;
}

checkHealth();
</script>
</body>
</html>
